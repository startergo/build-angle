name: Build Bottles

on:
  push:
    branches: [master]
    paths:
      - 'Formula/**'
      - '.github/workflows/**'
  pull_request:
    branches: [master]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to tag (e.g., 1.0.0)'
        required: true
        default: '1.0.0'
      release:
        description: 'Create GitHub release?'
        required: false
        default: false
        type: boolean

permissions:
  contents: write

jobs:
  determine-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      create_release: ${{ steps.version.outputs.create_release }}
    steps:
      - id: version
        run: |
          VERSION="${{ github.event.inputs.version }}"
          if [ -z "$VERSION" ]; then
            VERSION="1.0.0"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          CREATE_RELEASE="${{ github.event.inputs.release }}"
          if [ "$CREATE_RELEASE" = "true" ] || [ "${{ github.ref }}" = "refs/heads/master" ]; then
            echo "create_release=true" >> $GITHUB_OUTPUT
          else
            echo "create_release=false" >> $GITHUB_OUTPUT
          fi

  build-bottle:
    needs: determine-version
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-15-intel
            arch: x64
          - os: macos-latest
            arch: arm64
    steps:
      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Set up Git
        uses: Homebrew/actions/git-user-config@master
        with:
          username: "startergo"

      - name: Checkout tap
        uses: actions/checkout@v4

      - name: Download build scripts
        run: |
          # Download build script and dependencies
          curl -o build.sh https://raw.githubusercontent.com/startergo/build-angle/main/build.sh
          curl -o clean_deps.py https://raw.githubusercontent.com/startergo/build-angle/main/clean_deps.py
          chmod +x build.sh

      - name: Install MacPorts
        run: |
          # Download and install MacPorts for macOS 15 Sequoia
          curl -L -O https://github.com/macports/macports-base/releases/download/v2.11.6/MacPorts-2.11.6-15-Sequoia.pkg
          sudo installer -pkg MacPorts-2.11.6-15-Sequoia.pkg -target / -verbose
          # Add MacPorts to PATH for all subsequent steps
          echo "/opt/local/bin:/opt/local/sbin" >> $GITHUB_PATH

      - name: Install build dependencies
        run: |
          sudo port install gn ninja rapidjson meson libpixman pkgconfig spice-protocol

      - name: Build ANGLE from source
        run: |
          # Build for matrix architecture
          ./build.sh ${{ matrix.arch }}

      - name: Install to staging
        run: |
          # Use matrix architecture
          arch="${{ matrix.arch }}"

          # Install to Homebrew prefix
          angle_dir="angle-$arch"

          # Copy libraries
          mkdir -p $(brew --prefix)/lib
          cp -R $angle_dir/lib/*.dylib $(brew --prefix)/lib/

          # Copy headers
          mkdir -p $(brew --prefix)/include
          cp -R $angle_dir/include/* $(brew --prefix)/include/

          # Copy pkgconfig files
          mkdir -p $(brew --prefix)/lib/pkgconfig
          cp $angle_dir/lib/pkgconfig/*.pc $(brew --prefix)/lib/pkgconfig/

          # Fix pkgconfig prefix
          sed -i.bak "s|^prefix=.*|prefix=$(brew --prefix)|" $(brew --prefix)/lib/pkgconfig/*.pc
          rm -f $(brew --prefix)/lib/pkgconfig/*.pc.bak

      - name: Create bottle
        run: |
          # Build bottle from installed files
          brew bottle startergo/angle --json --root-url=https://github.com/startergo/homebrew-angle/releases/download/v${{ needs.determine-version.outputs.version }}

      - name: Upload bottle artifact
        uses: actions/upload-artifact@v4
        with:
          name: bottle-${{ matrix.arch }}
          path: "*.rb"
          if-no-files-found: ignore

  publish-bottles:
    needs: [determine-version, build-bottle]
    runs-on: ubuntu-latest
    if: needs.determine-version.outputs.create_release == 'true'
    steps:
      - name: Checkout tap
        uses: actions/checkout@v4

      - name: Download all bottles
        uses: actions/download-artifact@v4
        with:
          pattern: bottle-*
          merge-multiple: true

      - name: Merge bottles into formula
        run: |
          # Collect all bottle JSONs
          ls -la *.rb *.json 2>/dev/null || true

          # Update formula with bottle block (Homebrew will handle this)
          for json in *.json; do
            if [ -f "$json" ]; then
              echo "Processing $json"
              cat "$json"
            fi
          done

      - name: Commit bottles to formula
        run: |
          git config user.email "actions@github.com"
          git config user.name "GitHub Actions"

          # Add bottle blocks to formula (this updates the sha256 sums)
          if ls *.json 2>/dev/null; then
            brew bottle --merge --write --no-commit *.json || true
            git add Formula/ || true
          fi

          git commit -m "Update bottles for v${{ needs.determine-version.outputs.version }}" || echo "No changes to commit"
          git push origin master || true

      - name: Create GitHub Release
        if: github.event_name == 'workflow_dispatch'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ needs.determine-version.outputs.version }}"

          # Get commit info
          COMMIT=$(git rev-parse --short HEAD)

          # Create or update release
          gh release create "v$VERSION" \
            --title "ANGLE v$VERSION" \
            --notes "Built from commit $COMMIT

          ### Bottles
          $(ls *.rb | sed 's/^/- /')" \
            --latest || true

          # Upload bottle files
          for rb in *.rb; do
            gh release upload "v$VERSION" "$rb" || true
          done
